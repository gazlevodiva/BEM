<html lang="ru">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

    <link href="css/fontawesome-free/css/all.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>

    <script src="js/main.js"></script>

    <title>Бизнес-Эмулятор 3000</title>
  </head>
  <body>

  	<div class="d-flex fixed-top flex-column flex-md-row align-items-center p-3 px-md-4 mb-3 bg-white border-bottom shadow-sm">
	  <h5 class="my-0 mr-md-auto font-weight-normal">Бизнес-Эмулятор 3000</h5>
	  <nav class="my-2 my-md-0 mr-md-3">
	    <a class="p-2 text-dark js-scroll-trigger" href="#">Рынок</a>
	    <a class="p-2 text-dark js-scroll-trigger" href="#cashflow">CashFlow</a>
	    <a class="p-2 text-dark js-scroll-trigger" href="#chart">График</a>
	  </nav>
	</div>


    <div class="container mt-5">
    	<div class="row">

    		<!-- SETTINGS ELEMENTS-->
    		<div class="col-md-10">


		    	<!-- MARKET -->
			    <div class="pricing-header px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center" id="market">
				  <h1 class="display-4">Рынок</h1>
				  <p class="lead">Добавляй новый рынок и задавай ему верные настройки</p>
				</div>
				<div class="container">
				  <div class="card-deck mb-3 text-center d-flex justify-content-center">

				  	<!-- PLACE FOR MARKET -->
				  	<div class="card-columns">
					    <div class="card mb-4 shadow-sm" id="add_market_btn">
					      <div class="card-body d-flex justify-content-center">
					        <button type="button" class="btn btn-block btn-outline-secondary" onclick="add_market_card()"><i class="fas fa-plus"></i></button>
					      </div>
					    </div>
					</div>

				  </div>
				</div>

				<!-- CASHFLOW -->
				<div class="pricing-header px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center" id="cashflow">
				  <h1 class="display-4">CashFlow</h1>
				</div>
				<div class="container">
				  <div class="card-deck mb-3 text-center">



				    <div class="card mb-4 shadow-sm">
				      <div class="card-header">
				        <h4 class="my-0 font-weight-normal">Штат</h4>
				      </div>
				      <div class="card-body">
				        <h2 class="card-title pricing-card-title" id="staff_specs">0 cпец<small class="text-muted"></small></h2>
				        <ul class="list-unstyled mt-3 mb-4" id="market_specs">
					          <li>...</li>
					    </ul>
				        <button type="button" class="btn btn-lg btn-block btn-outline-secondary" data-toggle="modal" data-target="#staff_modal">Настройки</button>
				      </div>
				    </div>

				    <div class="modal fade" id="staff_modal" tabindex="-1" role="dialog" aria-labelledby="staff_modal" aria-hidden="true">
	                    <div class="modal-dialog">
	                    	<div class="modal-content">
	                    		<div class="modal-header">
	                    			<h5 class="modal-title" id="staff_modal">Настройки</h5>
                   					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    				 	<span aria-hidden="true">&times;</span>
                    				</button>
                    			</div>
                    			<div class="modal-body">
                    			<h4 class="mb-3" id="staff_modal_name">Настройка штата сотрудников</h4>
                   				<form id="staff_modal_settings" name="staff-form" method="post">
                   					<div id="header-elem-staff"></div>
	                    			<button type="button" class="btn btn-outline-secondary" onclick="adder('staff')">Добавить данные</button>
	                   				<button type="button" class="btn btn-secondary mx-2" data-dismiss="modal">Закрыть</button>
                   					<button type="button" class="btn btn-primary"
                   					onclick="AcceptStaffChange( document.getElementById('staff_modal_settings').elements )">Сохранить</button>
				                </form>
				            </div>
				        </div>
				    </div>
				</div>

				    <div class="card mb-4 shadow-sm">
				      <div class="card-header">
				        <h4 class="my-0 font-weight-normal">Прибыль</h4>
				      </div>
				      <div class="card-body">
				        <h2 class="card-title pricing-card-title mt-5" id="profit_year"><small class="text-muted"></small></h2>
				      </div>
				    </div>

				    <div class="card mb-4 shadow-sm bg-secondary">
				      <div class="card-header">
				        <h4 class="my-0 font-weight-normal">Инвестор</h4>
				      </div>
				      <div class="card-body">
				        <h2 class="card-title pricing-card-title" id="investor_year">$0m/0%<small class="text-muted"></small></h2>
				        <button type="button" class="btn btn-lg btn-block btn-outline-secondary">inprocess</button>
				      </div>
				    </div>

				    <div class="card mb-4 shadow-sm bg-secondary">
				      <div class="card-header">
				        <h4 class="my-0 font-weight-normal">Кредит</h4>
				      </div>
				      <div class="card-body">
				        <h2 class="card-title pricing-card-title" id="credit_year">$0/0%<small class="text-muted"></small></h2>
				        <button type="button" class="btn btn-lg btn-block btn-outline-secondary">inprocess</button>
				      </div>
				    </div>

				  </div>
				</div>



				<!-- PRODUCT READINESS-->
				<div class="pricing-header px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center">
				    <h1 class="display-4">Готовность продукта</h1>
				    <div class="progress mt-5">
					    <div class="progress-bar progress-bar-striped bg-info" 
					         role="progressbar" 
					         style="width: 0%" 
					         aria-valuenow="50" 
					         aria-valuemin="0" 
					         aria-valuemax="100" 
					         id="product_readiness_progressbar">
					     	0%
					 	</div>
				    </div>
				</div>

				<!-- CHART -->
				<div class="mb-5" id="chart">
					<div class="pricing-header px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center">
					  <h1 class="display-4">График</h1>
					</div>
					<canvas id="myChart"></canvas>
				</div>


				<!-- MODAL WINDOW -->
				<div id="add_modal_place"></div>
			
			</div>

			<!-- SLIDER -->
			<div class="col-md-2 mt-5 d-flex justify-content-center">
				<input type="range" id="vertical_slider" min='2020' max='2050' step="1" value='2020'/>
				<h2 class="text-center d-flex justify-content-center"id='current_year'>2020</h2>
			</div>

			<script>
				
				var year_slider = document.getElementById('vertical_slider');
				var current_year = document.getElementById('current_year');
				var staff_specs = document.getElementById('staff_specs');
				var profit_year = document.getElementById('profit_year');
				var investor_year = document.getElementById('investor_year');				
				var credit_year = document.getElementById('credit_year');
				var product_readiness_progressbar = document.getElementById('product_readiness_progressbar');
				const reducer = (accumulator, currentValue) => accumulator + currentValue;


				// Logic Summary Variebles
				var product_readiness = 0;

				var ctx = document.getElementById('myChart').getContext('2d');
				var config = {
				    // The type of chart we want to create
				    type: 'line',

				    // The data for our dataset
				    data: {
				        labels: [2020],
				        datasets: [{
				            label: 'Затраты',
				            backgroundColor: '#B22222',
				            borderColor: '#B22222',
				            data: [0],
				            fill: false,
				        },{
				            label: 'Общая прибыль',
				            backgroundColor: '#2E8B57',
				            borderColor: '#2E8B57',
				            data: [0],
				            fill: false,
				        },]
				    },

				    // Configuration options go here
				    options: {
						responsive: true,
						title: {
							display: true,
						},
						tooltips: {
							mode: 'index',
							intersect: false,
						},
						hover: {
							mode: 'nearest',
							intersect: true
						},
						scales: {
							x: {
								display: true,
								scaleLabel: {
									display: true,
									labelString: 'Month'
								}
							},
							y: {
								display: true,
								scaleLabel: {
									display: true,
									labelString: 'Value'
								}
							}
						}
					}
				};
				var chart = new Chart(ctx, config);

				current_year.innerHTML = START_YEAR;
				staff_specs.innerHTML = '0 cпец<small class="text-muted"> / '+START_YEAR+'</small>';
				profit_year.innerHTML = '0 $<small class="text-muted"> / '+START_YEAR+'</small>';
				product_readiness_progressbar.innerHTML = 0;

				// Общаяя готовность продукта
				var total_product_readiness = 0;

				// Main Logic
				year_slider.oninput = function() {
				    current_year.innerHTML = this.value;
					staff_specs.innerHTML = getlast(STAFF)+' cпец<small class="text-muted"> / '+this.value+'</small>';
				    
					// Прогресс бар готовности продукта
					var current_staff = getlast(STAFF)
					var staff_productivity = 0.0954*current_staff;
					if(this.value > CURRENT_YEAR){
						total_product_readiness+=staff_productivity
				    }

					total_product_readiness = total_product_readiness <= 100 ? total_product_readiness : 100
					product_readiness_progressbar.innerHTML = total_product_readiness+'%';
					product_readiness_progressbar.setAttribute("style", "width:"+total_product_readiness+"%");

					// change values for each market
					for (market_id in MARKET){
						
						//Продуктивность каждой категории работниковв процентах 0-100%						
						let current_market_specs = getlast(MARKET[market_id].specs);
						let market_specs_productivity = 5*current_market_specs;

						// Отрисовка маркетологов на каждом рынке касательно года
				    	document.getElementById('specs_market_'+market_id).innerHTML = current_market_specs+' спец<small class="text-muted" id="market_year_'+market_id+
				    																	'"> / '+this.value+'</small>';;

						// Заработок с рынка
				  		current_market_share = (staff_productivity+market_specs_productivity)/200*2.5*1000000;
				  		MARKET_SHARE[market_id].push(current_market_share);
				  		let market_share = MARKET_SHARE[market_id].reduce(reducer);

				  		config.data.datasets[parseInt(market_id)+2].data.push( Math.round(market_share) );

				  		
					  	// ЛОГИ:)
					  	console.log(MARKET[market_id].name+': Штаб - '+current_staff+
					  				'; Маркетологи - '+current_market_specs+
					  				'; Доля с рынка - '+market_share+
					  				'; Затраты - '+50000 * (current_staff + getlast(MARKET[market_id].specs)) 
					  				);
					}


					// Карточка прибыли и затрат
					// Прибыль по годам
					PROFIT[this.value] = 0; 
					total_market_profit = 0;
					total_expenses = getlast(STAFF)*50000;
					for (x in MARKET_SHARE){	
						if (this.value > CURRENT_YEAR){					
							total_market_profit += MARKET_SHARE[x].reduce(reducer);
							PROFIT[this.value] += total_market_profit
							total_expenses += 50000*getlast(MARKET[x].specs);
						} 
					}

			  		// // INVESTOR
			  		// if(INVESTOR[this.value] !== undefined){
			  		// 	company_invest_cost = total_market_profit*5*INVESTOR[this.value];
			  		// 	total_market_profit+=company_invest_cost
			  		// 	alert(company_invest_cost)
			  		// } else { company_invest_cost = 0 }
			  		// investor_year.innerHTML = company_invest_cost/1000000+'m <small class="text-muted"> / '+this.value+'</small>';



			  		// // CREDIT
				   //  credit_year.innerHTML = 0+' <small class="text-muted"> / '+this.value+'</small>';







				    // ПРИБЫЛЬ И ЗАТРАТЫ
			  		profit_year.innerHTML = Math.round(total_market_profit/1000000)+'m <small class="text-muted"> / '+this.value+'</small>';
			  		config.data.datasets[0].data.push( total_expenses );
			  		config.data.datasets[1].data.push( total_market_profit );



					// SLIDER UP AND DOWN TO CHANGE CHART
				    if(this.value > CURRENT_YEAR){
				  	    config.data.labels.push(this.value);
				    }else{
				  		config.data.labels.splice(-1, 1);
				    }

				    CURRENT_YEAR = this.value;
				    chart.update();
				}
			</script>

		</div>
	</div>



    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
    <!-- <script src="Chart.min.js"></script> -->
  </body>
</html>